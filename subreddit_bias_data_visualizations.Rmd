---
title: "Subreddit Bias Data Visualizations and Summaries"
author: "Drew Walker"
date: "4/16/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(tm)
library(tidytext)
library(lubridate)
```

```{r ggplot_word}

all_posts_df <- read_csv("all_subreddit_bias_posts.csv")

word_list_with_stem <- read_csv("word_list_round_2.csv")
word_list_with_stem$similar_word <- str_replace_all(word_list_with_stem$similar_word,"_"," ")
#bias_words <- as.tibble(c("abuser","junkie","alcoholic","drunk","habit","dirty","stigma","bias","stereotype","shame","blame"))
#"abuser|junkie|alcoholic|drunk|habit|dirty|stigma|bias|stereotype|shame|blame"

bias_words_df <- read_csv("expanded_misspellings.csv")
#Columns 0-27 include all misspelling words
no_misspellings_word_list <- bias_words_df %>% 
  pivot_longer(!X1, names_to = "number",values_to ="ms_word") %>% 
  filter(number == "0") %>% 
  filter(is.na(ms_word)) %>% 
  select(regex = X1) %>% 
  mutate(similar_word = regex) %>% 
  left_join(word_list_with_stem,by = "similar_word")

bias_words_list <- bias_words_df %>% 
  pivot_longer(!X1, names_to = "number",values_to ="ms_word") %>% 
  drop_na() %>% 
  rename(similar_word = X1) %>% 
  left_join(word_list_with_stem, by = "similar_word") %>% 
  group_by(stem_word) %>% 
  mutate(regex = paste(ms_word,collapse="|")) %>% 
  distinct(stem_word,.keep_all = TRUE) %>% 
  select(stem_word,regex,similar_word)

regex_list <- bind_rows(no_misspellings_word_list,bias_words_list) 

regex_list2 <- regex_list %>% 
    group_by(stem_word) %>% 
  mutate(regex2 = paste(regex,collapse="|")) %>% 
  distinct(stem_word,.keep_all = TRUE)  

get_summary_plot <- function(word){
word_df <- all_posts_df %>%
  filter(str_detect(body, word)) %>% 
  mutate(day = as.Date(date(created)),
         month_year = floor_date(day, "month")) %>% 
  group_by(month_year) %>% 
  mutate(count = n(),
         regex2 = word) %>% 
  left_join(regex_list2, by = "regex2")
  
plot_obs <- ggplot(data=word_df,         
                   aes(x = month_year,
                       y = count))+
  geom_line()+
  #adding lines to plot
                   theme_classic() + 
  ggtitle(paste(word_df$stem_word))+
                   scale_y_continuous(name = "Monthly Comments or Posts") 
return(plot_obs)
}

get_summary_df <- function(word){
word_df <- all_posts_df %>%
  filter(str_detect(body, word)) %>% 
  mutate(day = as.Date(date(created)),
         month_year = floor_date(day, "month")) %>% 
  group_by(month_year) %>% 
  summarize(count = n())
return(word_df)}
junkie_df <- get_summary_df("junkie")


```
iteration
```{r iterated-bias-sample}
library(purrr)
library(furrr)
library(gridExtra)
library(patchwork)
possible_summary_plot <- purrr::possibly(get_summary_plot, otherwise = tidyr::tibble("NA"))
possible_summary_df <- purrr::possibly(get_summary_df, otherwise = tidyr::tibble("NA"))


bias_words_full <- regex_list2 %>% 
  mutate(summary_plot = future_map(regex2, possible_summary_plot),
         summary_df = future_map(regex2,possible_summary_df)) 

plots <- bias_words_full$summary_plot
wrap_plots(plots)
ggsave('bias_terms_plots.png', width = 15)

stem_word_and_regex <- regex_list2 %>% 
  select(stem_word, regex=regex2)

write_csv(stem_word_and_regex, "stem_word_and_regex.csv")
```

